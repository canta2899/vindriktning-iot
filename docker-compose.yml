version: "3"
services:
  engine:
    build:
      context: .
      dockerfile: Dockerfile_engine
    container_name: engine 
    environment:
      - MOSQUITTO_USERNAME=${MOSQUITTO_USERNAME}
      - MOSQUITTO_PASSWORD=${MOSQUITTO_PASSWORD}
      - SENSOR_STATUS_ENDPOINT=${SENSOR_STATUS_ENDPOINT}
      - DATA_ENDPOINT=${DATA_ENDPOINT}
      - NOTIFICATION_ENDPOINT=${NOTIFICATION_ENDPOINT}
      - AUTH_ENDPOINT=${AUTH_ENDPOINT}
      - AUTH_APPNAME=${AUTH_APPNAME}
      - AUTH_PASS=${AUTH_PASS}
    depends_on:
      - "broker"
      - "monitortool"
    restart: always

  monitortool:
    build:
      context: .
      dockerfile: Dockerfile_monitortool
    container_name: monitortool
    environment:
      - INFLUXDB_API_USER=${INFLUXDB_API_USER}
      - INFLUXDB_API_PASSWORD=${INFLUXDB_API_PASSWORD}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
    volumes:
      - tokens:/tokens
      - ./log:/log
    ports:
      - "8000:5000"
    depends_on:
      - "database"
    restart: always

  broker:
    build:
      context: .
      dockerfile: Dockerfile_broker 
    environment:
      - MOSQUITTO_USERNAME=${MOSQUITTO_USERNAME}
      - MOSQUITTO_PASSWORD=${MOSQUITTO_PASSWORD}
    container_name: broker
    ports:
      - "1883:1883"
    volumes:
      - ./broker/config:/mosquitto/config
      - ./broker/log:/mosquitto/log
    restart: always

  database:
    build:
      context: .
      dockerfile: Dockerfile_influxdb
    container_name: database
    environment:  
      - INFLUXDB_ADMIN_USER=${INFLUXDB_ADMIN_USER}
      - INFLUXDB_ADMIN_PASSWORD=${INFLUXDB_ADMIN_PASSWORD}
    volumes:
      - db:/var/lib/influxdb
    ports:
      - "8086:8086"
    restart: always 
    
  charts:
    image: grafana/grafana
    container_name: charts
    volumes:
      - grafana:/var/lib/grafana
    ports:
      - "3000:3000"

volumes:
  tokens:
  grafana:
  db:

