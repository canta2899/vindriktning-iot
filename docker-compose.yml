version: "3"
services:
  engine:
    build:
      context: ./dockerfiles
      dockerfile: Dockerfile_engine
    container_name: mqtt_app
    volumes:
      - log:/log
    environment:
      - INFLUXDB_MQTT_USER=${INFLUXDB_MQTT_USER}
      - INFLUXDB_MQTT_PASSWORD=${INFLUXDB_MQTT_PASSWORD}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - MOSQUITTO_USERNAME=${MOSQUITTO_USERNAME}
      - MOSQUITTO_PASSWORD=${MOSQUITTO_PASSWORD}
    depends_on:
      - "broker"
      - "database"
      - "logapp"
    restart: always

  accesstool:
    build:
      context: ./dockerfiles
      dockerfile: Dockerfile_accesstool
    container_name: logapp
    environment:
      - INFLUXDB_MQTT_USER=${INFLUXDB_MQTT_USER}
      - INFLUXDB_MQTT_PASSWORD=${INFLUXDB_MQTT_PASSWORD}
    volumes:
      - tokens:/tokens
      - log:/log
    ports:
      - "8000:5000"
    restart: always

  broker:
    build:
      context: ./dockerfiles
      dockerfile: Dockerfile_broker 
    environment:
      - MOSQUITTO_USERNAME=${MOSQUITTO_USERNAME}
      - MOSQUITTO_PASSWORD=${MOSQUITTO_PASSWORD}
    container_name: broker
    ports:
      - "1883:1883"
    volumes:
      - ./broker/data:/mosquitto/data
      - ./broker/config:/mosquitto/config
      - ./broker/log:/mosquitto/log
    restart: always

  database:
    build:
      context: ./dockerfiles
      dockerfile: Dockerfile_influxdb
    container_name: database
    environment:  
      - INFLUXDB_ADMIN_USER=${INFLUXDB_ADMIN_USER}
      - INFLUXDB_ADMIN_PASSWORD=${INFLUXDB_ADMIN_PASSWORD}
    volumes:
      - db:/var/lib/influxdb
    ports:
      - "8086:8086"
    restart: always 
    
  charts:
    image: grafana/grafana
    container_name: charts
    volumes:
      - grafana:/var/lib/grafana
    ports:
      - "3000:3000"

volumes:
  log:
  tokens:
  grafana:
  db:

