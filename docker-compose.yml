version: "3"
services:
  mqtt_app:
    build:
      context: .
      dockerfile: Dockerfile_subscriber
    container_name: mqtt_app
    environment:
      - INFLUXDB_MQTT_USER=${INFLUXDB_MQTT_USER}
      - INFLUXDB_MQTT_PASSWORD=${INFLUXDB_MQTT_PASSWORD}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - MOSQUITTO_USERNAME=${MOSQUITTO_USERNAME}
      - MOSQUITTO_PASSWORD=${MOSQUITTO_PASSWORD}
    depends_on:
      - "broker"
      - "database"
      - "logapp"
    restart: always

  logapp:
    build:
      context: .
      dockerfile: Dockerfile_logger
    container_name: logapp
    volumes:
      - logvolume:/log
    ports:
      - "8000:5000"
    restart: always

  broker:
    build:
      context: .
      dockerfile: Dockerfile_broker 
    environment:
      - MOSQUITTO_USERNAME=${MOSQUITTO_USERNAME}
      - MOSQUITTO_PASSWORD=${MOSQUITTO_PASSWORD}
    container_name: broker
    ports:
      - "1883:1883"
    volumes:
      - ./broker/data:/mosquitto/data
      - ./broker/config:/mosquitto/config
      - ./broker/log:/mosquitto/log
    restart: always

  database:
    build:
      context: .
      dockerfile: Dockerfile_influxdb
    container_name: database
    environment:  
      - INFLUXDB_ADMIN_USER=${INFLUXDB_ADMIN_USER}
      - INFLUXDB_ADMIN_PASSWORD=${INFLUXDB_ADMIN_PASSWORD}
    ports:
      - "8086:8086"
    restart: always 
    
  charts:
    image: grafana/grafana
    container_name: charts
    volumes:
      - grafana:/var/lib/grafana
    ports:
      - "3000:3000"

volumes:
  logvolume:
  grafana:

